name: Tests

on:
  push:
    branches: [master, main, develop]
    paths:
      - 'App/**'
      - 'OfflineMediaDownloaderTests/**'
      - 'OfflineMediaDownloader.xcodeproj/**'
      - 'Package.swift'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [master, main, develop]
    paths:
      - 'App/**'
      - 'OfflineMediaDownloaderTests/**'
      - 'OfflineMediaDownloader.xcodeproj/**'
      - 'Package.swift'
      - '.github/workflows/tests.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: OfflineMediaDownloader
  PROJECT: OfflineMediaDownloader.xcodeproj

jobs:
  test:
    name: Run Tests
    runs-on: macos-14
    timeout-minutes: 35

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Development Configuration
        run: |
          cat > Development.xcconfig << 'EOF'
          // CI Configuration - placeholder values for testing
          MEDIA_DOWNLOADER_API_KEY = CI_PLACEHOLDER_KEY
          MEDIA_DOWNLOADER_BASE_PATH = https:/$()/example.com/
          EOF

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$XCODE_PATH" ]; then
            sudo xcode-select -s "$XCODE_PATH"
          fi
          xcodebuild -version

      - name: Cache Xcode Build
        uses: actions/cache@v5
        with:
          path: |
            DerivedData
            SourcePackages
          key: ${{ runner.os }}-xcode-${{ hashFiles('**/*.swift', '**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-

      - name: Resolve Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -clonedSourcePackagesDirPath SourcePackages \
            -derivedDataPath DerivedData \
            -skipPackagePluginValidation \
            -skipMacroValidation

      - name: Find Simulator
        id: simulator
        run: |
          # List available simulators for debugging
          echo "Available iOS runtimes:"
          xcrun simctl list runtimes | grep iOS || true

          echo "Available iPhone devices:"
          xcrun simctl list devices available | grep iPhone || true

          # Find an iPhone simulator preferring iOS 18 runtimes (compatible with Xcode 16)
          # First try iOS 18, then fall back to any iOS version
          DEVICE_INFO=$(xcrun simctl list devices available -j | \
            jq -r '.devices | to_entries[] | select(.key | test("iOS-18")) | .value[] | select(.name | startswith("iPhone")) | "\(.name)|\(.udid)"' | \
            head -1)
          
          # Fallback to any iOS runtime if no iOS 18 devices found
          if [ -z "$DEVICE_INFO" ]; then
            echo "No iOS 18 simulators found, trying any iOS version..."
            DEVICE_INFO=$(xcrun simctl list devices available -j | \
              jq -r '.devices | to_entries[] | select(.key | test("iOS-[0-9]+")) | .value[] | select(.name | startswith("iPhone")) | "\(.name)|\(.udid)"' | \
              sort -V | tail -1)
          fi

          if [ -n "$DEVICE_INFO" ]; then
            DEVICE_NAME=$(echo "$DEVICE_INFO" | cut -d'|' -f1)
            DEVICE_ID=$(echo "$DEVICE_INFO" | cut -d'|' -f2)
            echo "Found iOS simulator: $DEVICE_NAME ($DEVICE_ID)"
            echo "device=$DEVICE_NAME" >> "$GITHUB_OUTPUT"
            echo "device_id=$DEVICE_ID" >> "$GITHUB_OUTPUT"
          else
            echo "No iPhone simulators found, using generic destination"
            echo "device=Any iOS Simulator Device" >> "$GITHUB_OUTPUT"
            echo "device_id=" >> "$GITHUB_OUTPUT"
          fi

      - name: Boot Simulator
        run: |
          DEVICE_ID="${{ steps.simulator.outputs.device_id }}"
          if [ -n "$DEVICE_ID" ]; then
            echo "Booting simulator $DEVICE_ID..."
            xcrun simctl boot "$DEVICE_ID" 2>/dev/null || true

            # Poll for simulator ready (max 30s)
            for i in {1..30}; do
              if xcrun simctl list devices | grep "$DEVICE_ID" | grep -q "Booted"; then
                echo "Simulator ready after ${i}s"
                break
              fi
              sleep 1
            done
          fi

      - name: Build for Testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee build.log | xcpretty --color || (cat build.log && exit 1)

      - name: Run Tests
        run: |
          set -o pipefail
          # Run unit tests with parallel execution enabled
          # Unit tests use withMainSerialExecutor for deterministic action ordering
          # Snapshot tests are skipped in CI (require local reference image generation)
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            -resultBundlePath TestResults.xcresult \
            -test-timeouts-enabled YES \
            -maximum-test-execution-time-allowance 120 \
            -parallel-testing-enabled YES \
            -only-testing:OfflineMediaDownloaderTests \
            -skip-testing:OfflineMediaDownloaderTests/FileCellSnapshotTests \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee test.log | xcpretty --color --report junit --output test-results.xml || (cat test.log && exit 1)

      - name: Upload Test Results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: test-results
          path: |
            TestResults.xcresult
            test-results.xml
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          if [ -f test-results.xml ]; then
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Parse test counts from JUnit XML (with fallbacks for empty results)
            TESTS=$(grep -o 'tests="[0-9]*"' test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")

            if [ -z "$TESTS" ]; then TESTS="0"; fi
            if [ -z "$FAILURES" ]; then FAILURES="0"; fi

            if [ "$FAILURES" = "0" ]; then
              echo "All $TESTS tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "$FAILURES of $TESTS tests failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            echo "No test results file found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Build Release
        run: |
          set -o pipefail
          # Verify Release configuration builds successfully
          # Uses same simulator and cached dependencies from test build
          xcodebuild build \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -configuration Release \
            -derivedDataPath DerivedData \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | tee release-build.log | xcpretty --color || (cat release-build.log && exit 1)
