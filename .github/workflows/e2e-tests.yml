name: E2E Tests

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch:
    inputs:
      run_device_farm:
        description: 'Run AWS Device Farm tests'
        required: false
        default: 'false'
        type: boolean

concurrency:
  group: e2e-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SCHEME: OfflineMediaDownloader
  PROJECT: OfflineMediaDownloader.xcodeproj

jobs:
  # ============================================
  # LocalStack Integration Tests
  # ============================================
  localstack-integration:
    name: LocalStack Integration Tests
    runs-on: macos-14
    timeout-minutes: 30

    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: apigateway,lambda,dynamodb,s3,sns,sqs
          DEBUG: 1

    steps:
      - name: Checkout iOS App
        uses: actions/checkout@v4

      - name: Checkout Backend (for fixtures)
        uses: actions/checkout@v4
        with:
          repository: j0nathan-ll0yd/aws-cloudformation-media-downloader
          path: backend
          ref: master
        continue-on-error: true

      - name: Create Development Configuration
        run: |
          cat > Development.xcconfig << 'EOF'
          // LocalStack Configuration
          MEDIA_DOWNLOADER_API_KEY = test-api-key-localstack
          MEDIA_DOWNLOADER_BASE_PATH = http:/$()/localhost:4566/restapis/test-api/local/_user_request_
          EOF

      - name: Sync Backend Fixtures
        run: |
          chmod +x ./Scripts/sync-backend-fixtures.sh
          ./Scripts/sync-backend-fixtures.sh

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$XCODE_PATH" ]; then
            sudo xcode-select -s "$XCODE_PATH"
          fi
          xcodebuild -version

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Wait for LocalStack
        run: |
          echo "Waiting for LocalStack to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:4566/_localstack/health | grep -q "running"; then
              echo "LocalStack is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Deploy Backend to LocalStack
        if: hashFiles('backend/package.json') != ''
        working-directory: backend
        run: |
          npm ci
          npm run deploy:local || echo "Backend deployment skipped"
        continue-on-error: true

      - name: Find Simulator
        id: simulator
        run: |
          DEVICE_INFO=$(xcrun simctl list devices available -j | \
            jq -r '.devices | to_entries[] | select(.key | contains("iOS-18")) | .value[] | select(.name | startswith("iPhone")) | "\(.name)|\(.udid)"' | \
            head -1)

          if [ -n "$DEVICE_INFO" ]; then
            DEVICE_NAME=$(echo "$DEVICE_INFO" | cut -d'|' -f1)
            DEVICE_ID=$(echo "$DEVICE_INFO" | cut -d'|' -f2)
            echo "device=$DEVICE_NAME" >> "$GITHUB_OUTPUT"
            echo "device_id=$DEVICE_ID" >> "$GITHUB_OUTPUT"
          else
            echo "device=iPhone 16" >> "$GITHUB_OUTPUT"
          fi

      - name: Build for Testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcpretty --color

      - name: Run Integration Tests
        env:
          LOCALSTACK_ENABLED: 'true'
          LOCALSTACK_API_ENDPOINT: 'http://localhost:4566/restapis/test-api/local/_user_request_'
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            -resultBundlePath IntegrationTestResults.xcresult \
            -only-testing:OfflineMediaDownloaderTests/IntegrationTests \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcpretty --color --report junit --output integration-test-results.xml || true

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            IntegrationTestResults.xcresult
            integration-test-results.xml
          retention-days: 7

  # ============================================
  # UI Tests with Stub Network
  # ============================================
  ui-tests:
    name: UI Tests (Stubbed Network)
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Development Configuration
        run: |
          cat > Development.xcconfig << 'EOF'
          MEDIA_DOWNLOADER_API_KEY = CI_PLACEHOLDER_KEY
          MEDIA_DOWNLOADER_BASE_PATH = https:/$()/example.com/
          EOF

      - name: Sync Backend Fixtures
        run: |
          chmod +x ./Scripts/sync-backend-fixtures.sh
          ./Scripts/sync-backend-fixtures.sh

      - name: Select Xcode
        run: |
          XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
          if [ -n "$XCODE_PATH" ]; then
            sudo xcode-select -s "$XCODE_PATH"
          fi
          xcodebuild -version

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
            .build
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved', '**/Package.swift') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Find Simulator
        id: simulator
        run: |
          DEVICE_INFO=$(xcrun simctl list devices available -j | \
            jq -r '.devices | to_entries[] | select(.key | contains("iOS-18")) | .value[] | select(.name | startswith("iPhone")) | "\(.name)|\(.udid)"' | \
            head -1)

          if [ -n "$DEVICE_INFO" ]; then
            DEVICE_NAME=$(echo "$DEVICE_INFO" | cut -d'|' -f1)
            DEVICE_ID=$(echo "$DEVICE_INFO" | cut -d'|' -f2)
            echo "device=$DEVICE_NAME" >> "$GITHUB_OUTPUT"
            echo "device_id=$DEVICE_ID" >> "$GITHUB_OUTPUT"
          else
            echo "device=iPhone 16" >> "$GITHUB_OUTPUT"
          fi

      - name: Boot Simulator
        run: |
          DEVICE_ID="${{ steps.simulator.outputs.device_id }}"
          if [ -n "$DEVICE_ID" ]; then
            xcrun simctl boot "$DEVICE_ID" 2>/dev/null || true
            sleep 10
          fi

      - name: Build for Testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcpretty --color

      - name: Run UI Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project "$PROJECT" \
            -scheme "$SCHEME" \
            -destination "platform=iOS Simulator,name=${{ steps.simulator.outputs.device }}" \
            -clonedSourcePackagesDirPath SourcePackages \
            -skipPackagePluginValidation \
            -skipMacroValidation \
            -resultBundlePath UITestResults.xcresult \
            -test-timeouts-enabled YES \
            -maximum-test-execution-time-allowance 300 \
            -only-testing:OfflineMediaDownloaderUITests \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcpretty --color --report junit --output ui-test-results.xml || true

      - name: Upload UI Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results
          path: |
            UITestResults.xcresult
            ui-test-results.xml
          retention-days: 7

      - name: Test Summary
        if: always()
        run: |
          echo "### UI Test Results" >> $GITHUB_STEP_SUMMARY
          if [ -f ui-test-results.xml ]; then
            TESTS=$(grep -o 'tests="[0-9]*"' ui-test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
            FAILURES=$(grep -o 'failures="[0-9]*"' ui-test-results.xml 2>/dev/null | head -1 | grep -o '[0-9]*' || echo "0")
            if [ "$FAILURES" = "0" ]; then
              echo "✅ All $TESTS UI tests passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "❌ $FAILURES of $TESTS UI tests failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "⚠️ No UI test results found" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # AWS Device Farm E2E Tests
  # ============================================
  device-farm-e2e:
    name: AWS Device Farm E2E
    runs-on: ubuntu-latest
    timeout-minutes: 60
    needs: [ui-tests]
    # Only run on main branch merges or manual trigger
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/master') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_device_farm == 'true')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ui-test-results
          path: artifacts
        continue-on-error: true

      # Note: Building for Device Farm requires macOS runner with code signing
      # This job would typically:
      # 1. Use a separate macOS job to build the IPA
      # 2. Upload to Device Farm
      # 3. Run tests on real devices
      #
      # For now, this is a placeholder that documents the intended flow.

      - name: Device Farm Test Placeholder
        run: |
          echo "### AWS Device Farm E2E Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Device Farm testing requires:" >> $GITHUB_STEP_SUMMARY
          echo "- AWS Device Farm project configured" >> $GITHUB_STEP_SUMMARY
          echo "- Code signing certificates in CI" >> $GITHUB_STEP_SUMMARY
          echo "- Test Apple ID for Sign in with Apple" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See: .github/workflows/device-farm-e2e.yml for full implementation" >> $GITHUB_STEP_SUMMARY

      # Uncomment when Device Farm is configured:
      # - name: Schedule Device Farm Run
      #   run: |
      #     aws devicefarm schedule-run \
      #       --project-arn ${{ secrets.DEVICE_FARM_PROJECT_ARN }} \
      #       --app-arn ${{ secrets.DEVICE_FARM_APP_ARN }} \
      #       --device-pool-arn ${{ secrets.DEVICE_FARM_DEVICE_POOL_ARN }} \
      #       --test "type=XCTEST_UI"
