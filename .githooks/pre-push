#!/usr/bin/env bash
set -euo pipefail

# pre-push hook: Block direct master pushes and verify build
# This enforces the worktree workflow and ensures code quality
#
# To bypass (emergency only): git push --no-verify

# Get the current branch name
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Block direct pushes to master/main
if [ "$CURRENT_BRANCH" = "master" ] || [ "$CURRENT_BRANCH" = "main" ]; then
  echo ""
  echo "ERROR: Direct push to '$CURRENT_BRANCH' is blocked."
  echo ""
  echo "This project requires the worktree workflow:"
  echo "  1. Create a worktree with a feature branch"
  echo "  2. Make changes in the worktree"
  echo "  3. Push the feature branch"
  echo "  4. Create a PR and merge via squash-and-merge"
  echo ""
  echo "To bypass (emergency only): git push --no-verify"
  exit 1
fi

echo "Running pre-push checks..."
echo "Verifying Xcode build..."
echo ""

# Build the project to verify it compiles
# Use generic iOS Simulator destination to work with any available simulator
# -skipMacroValidation bypasses Xcode's interactive macro approval requirement
xcodebuild -project OfflineMediaDownloader.xcodeproj \
  -scheme OfflineMediaDownloader \
  -destination 'generic/platform=iOS Simulator' \
  -skipMacroValidation \
  -quiet \
  build

BUILD_RESULT=$?

if [ $BUILD_RESULT -ne 0 ]; then
  echo ""
  echo "ERROR: Xcode build failed. Please fix build errors before pushing."
  echo ""
  echo "To bypass (emergency only): git push --no-verify"
  exit 1
fi

echo ""
echo "âœ… Build successful. Proceeding with push."
exit 0
