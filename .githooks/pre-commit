#!/bin/bash

# Pre-commit hook for ios-OfflineMediaDownloader
# This hook runs before each commit to ensure code quality
#
# To enable this hook, run:
#   git config core.hooksPath .githooks
#
# Or symlink manually:
#   ln -s ../../.githooks/pre-commit .git/hooks/pre-commit

set -euo pipefail

echo "Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Track if any checks fail
CHECKS_PASSED=true

# Get the root directory of the repository
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check if we have staged Swift files
STAGED_SWIFT_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$' || true)

if [ -z "$STAGED_SWIFT_FILES" ]; then
    echo -e "${YELLOW}No Swift files staged for commit. Skipping checks.${NC}"
    exit 0
fi

echo "Checking staged Swift files..."
echo "$STAGED_SWIFT_FILES"
echo ""

# ==============================================================================
# Check 1: SwiftFormat (if installed)
# ==============================================================================
if command -v swiftformat &> /dev/null; then
    echo "Running SwiftFormat..."

    # Run SwiftFormat on staged files
    for file in $STAGED_SWIFT_FILES; do
        if [ -f "$file" ]; then
            swiftformat "$file" --lint 2>/dev/null || {
                echo -e "${RED}SwiftFormat issues found in: $file${NC}"
                echo "Run 'swiftformat $file' to fix formatting issues"
                CHECKS_PASSED=false
            }
        fi
    done

    if [ "$CHECKS_PASSED" = true ]; then
        echo -e "${GREEN}SwiftFormat check passed${NC}"
    fi
else
    echo -e "${YELLOW}SwiftFormat not installed. Install with: brew install swiftformat${NC}"
fi

echo ""

# ==============================================================================
# Check 2: SwiftLint (if installed)
# ==============================================================================
if command -v swiftlint &> /dev/null; then
    echo "Running SwiftLint..."

    # Create a temp file with staged file paths
    TEMP_FILE=$(mktemp)
    echo "$STAGED_SWIFT_FILES" > "$TEMP_FILE"

    # Run SwiftLint on staged files
    for file in $STAGED_SWIFT_FILES; do
        if [ -f "$file" ]; then
            swiftlint lint --quiet --path "$file" 2>/dev/null || {
                echo -e "${YELLOW}SwiftLint warnings found in: $file${NC}"
            }
        fi
    done

    rm -f "$TEMP_FILE"
    echo -e "${GREEN}SwiftLint check completed${NC}"
else
    echo -e "${YELLOW}SwiftLint not installed. Install with: brew install swiftlint${NC}"
fi

echo ""

# ==============================================================================
# Check 3: Swift compilation check (for modified dependency files)
# ==============================================================================
echo "Checking Swift syntax..."

# Check if APITypes package needs to be rebuilt
if echo "$STAGED_SWIFT_FILES" | grep -q "APITypes/"; then
    echo "APITypes modified, checking package build..."
    if [ -d "APITypes" ]; then
        cd APITypes
        if ! swift build 2>/dev/null; then
            echo -e "${RED}APITypes package build failed${NC}"
            CHECKS_PASSED=false
        else
            echo -e "${GREEN}APITypes package builds successfully${NC}"
        fi
        cd "$REPO_ROOT"
    fi
fi

echo ""

# ==============================================================================
# Check 4: Prevent committing sensitive files
# ==============================================================================
echo "Checking for sensitive files..."

SENSITIVE_PATTERNS=(
    "Development.xcconfig"
    ".env"
    "*.pem"
    "*.p12"
    "credentials.json"
    "secrets.json"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if echo "$STAGED_SWIFT_FILES" | grep -q "$pattern"; then
        echo -e "${RED}Warning: Attempting to commit sensitive file matching pattern: $pattern${NC}"
        echo "If this is intentional, use 'git commit --no-verify'"
        CHECKS_PASSED=false
    fi
done

# Also check non-Swift staged files for sensitive patterns
STAGED_ALL_FILES=$(git diff --cached --name-only --diff-filter=ACM)
for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    MATCHED=$(echo "$STAGED_ALL_FILES" | grep "$pattern" || true)
    if [ -n "$MATCHED" ]; then
        echo -e "${RED}Warning: Attempting to commit sensitive file: $MATCHED${NC}"
        echo "If this is intentional, use 'git commit --no-verify'"
        CHECKS_PASSED=false
    fi
done

if [ "$CHECKS_PASSED" = true ]; then
    echo -e "${GREEN}No sensitive files detected${NC}"
fi

echo ""

# ==============================================================================
# Check 5: Check for TODO/FIXME markers (warning only)
# ==============================================================================
echo "Checking for TODO/FIXME markers in staged changes..."

TODO_COUNT=0
for file in $STAGED_SWIFT_FILES; do
    if [ -f "$file" ]; then
        FILE_TODOS=$(git diff --cached "$file" | grep -c "^\+.*\(TODO\|FIXME\)" || true)
        TODO_COUNT=$((TODO_COUNT + FILE_TODOS))
    fi
done

if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}Found $TODO_COUNT new TODO/FIXME markers in staged changes${NC}"
    echo "Consider addressing these before committing."
fi

echo ""

# ==============================================================================
# Final result
# ==============================================================================
if [ "$CHECKS_PASSED" = false ]; then
    echo -e "${RED}Pre-commit checks failed. Please fix the issues above.${NC}"
    echo "To bypass this check, use: git commit --no-verify"
    exit 1
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
exit 0
